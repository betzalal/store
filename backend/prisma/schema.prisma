generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model Store {
  id        Int       @id @default(autoincrement())
  name      String
  location  String?
  description String? // New: Detailed description
  category    String? // New: Store type/category
  photos      String? // New: JSON string for photo URLs
  staff       String? // New: JSON string for staff hierarchy
  products  Product[]
  sales     Sale[]
  expenses  Expense[]
  users     User[]    // Users assigned to this store
  promoCodes PromoCode[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model Expense {
  id          Int      @id @default(autoincrement())
  description String
  amount      Float
  category    String?  // Ej: Arriendo, Servicios, Personal
  date        DateTime @default(now())
  storeId     Int
  store       Store    @relation(fields: [storeId], references: [id])
  createdAt   DateTime @default(now())
}

model Product {
  id            Int      @id @default(autoincrement())
  code          String   @default("PROD-000") // Removed global @unique
  name          String
  category      String   @default("General")
  unit          String?  @default("pz")
  price         Float
  providerPrice Float?   @default(0)
  providerName  String?
  comparePrice  Float?   @default(0)
  imageUrl      String?
  stock         Float    @default(0) // Changed to Float for weight/volume/area units
  storeId       Int
  store         Store    @relation(fields: [storeId], references: [id])
  sales         SaleItem[]
  history       ProductHistory[]
  
  @@unique([code, storeId]) // Unique code per store
  
  // Bundling Support
  isBundle      Boolean           @default(false)
  components    BundleComponent[] @relation("BundleParent")
  partOfBundles BundleComponent[] @relation("BundleChild")

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model BundleComponent {
  id          Int     @id @default(autoincrement())
  bundleId    Int
  bundle      Product @relation("BundleParent", fields: [bundleId], references: [id])
  componentId Int
  component   Product @relation("BundleChild", fields: [componentId], references: [id])
  quantity    Float
}

model ProductHistory {
  id          Int      @id @default(autoincrement())
  type        String   // Ej: "Ingreso", "Salida", "Edici√≥n"
  quantity    Float
  date        DateTime @default(now())
  details     String?
  productId   Int
  product     Product  @relation(fields: [productId], references: [id])
}

model Sale {
  id           Int        @id @default(autoincrement())
  storeId      Int
  store        Store      @relation(fields: [storeId], references: [id])
  total        Float
  items        SaleItem[]
  date         DateTime   @default(now())
  status       String     @default("Completed") // Completed, Canceled, Returned, Donated
  customerName String?    @default("Cliente General")
  customerNit   String?
  customerWhatsapp String?
  orderType     String     @default("Venta en Tienda") // Venta en Tienda, Envio, Orden, Reserva, Cotizacion
  paymentMethod String     @default("Cash") // Cash, QR, Deposito
  discount      Float?     @default(0)
  couponCode    String?
  userId        Int?       // Tracking who made the sale
  user          User?      @relation(fields: [userId], references: [id])
}

model SaleItem {
  id        Int     @id @default(autoincrement())
  saleId    Int
  sale      Sale    @relation(fields: [saleId], references: [id])
  productId Int
  product   Product @relation(fields: [productId], references: [id])
  quantity  Float
  price     Float
}

model User {
  id        Int      @id @default(autoincrement())
  username  String   @unique
  password  String
  role      String   @default("staff")
  stores    Store[]  // Stores this user provides services to/can manage
  createdAt DateTime @default(now())
  sales     Sale[]   // Sales made by this user
  memories  Memory[] // Actions logged by this user
}

model Memory {
  id        Int      @id @default(autoincrement())
  action    String
  details   String?
  timestamp DateTime @default(now())
  userId    Int?
  user      User?    @relation(fields: [userId], references: [id])
}

model SystemConfig {
  id             Int     @id @default(autoincrement())
  companyName    String  @default("My Company")
  logoUrl        String?
  slogan         String?
  themeMode      String  @default("dark")
  backgroundUrl  String?
  nit            String? // New field for Company NIT
  categoryIcons  String? // JSON string for category icon mapping
  isSetup        Boolean @default(false)
}

model PromoCode {
  id             Int      @id @default(autoincrement())
  code           String   @unique
  name           String   // Campaign name
  storeId        Int?     // If null, valid for all stores
  store          Store?   @relation(fields: [storeId], references: [id])
  externalStore  String?  // Name of external brand or store offering the coupon
  validUntil     DateTime // Expiration Date
  maxUses        Int      @default(0) // 0 = unlimited, otherwise max uses
  discountType   String   @default("percentage") // "percentage" or "fixed"
  discountValue  Float    // e.g. 10 for 10%, or 50 for 50 Bs
  productIds     String?  // JSON array of specific product IDs, empty/null if it applies to whole cart
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}
